# 用户故事

面向保险代理团队成员的积分管理与激励工具。通过“积分事项/积分发放/积分兑换”形成可追溯的激励闭环，促进成员展业并对团队贡献进行量化。

## 角色

- 管理员：维护积分事项与兑换商品，给代理人发放积分，监管整体积分与兑换情况
- 代理人：查看积分余额与明细，浏览兑换商品并使用积分兑换

## 说明

本用户故事聚焦“写入行为 + 关键规则”。常规的查询能力（列表/详情）在各角色故事里会隐含出现，这里统一在文末补充。

## 名词解释

- 代理人：以 `agentCode` 作为稳定标识（例如 8 位编码）
- 积分事项：决定“什么事情可得积分/默认积分值/每年最多几次/附加标准”的配置项
- 积分记录：一次具体发放（代理人、积分事项、积分值、备注、时间等）
- 当前积分：代理人的可用积分余额（可由明细汇总得到，也可维护余额快照用于加速）
- 兑换商品：可用积分兑换的商品，有生命周期（草稿/发布/下架）与库存
- 兑换记录：一次具体兑换（扣减积分、消耗库存、时间、状态等）
- 操作日志：管理员的所有写操作记录（用于审计与追溯）

## 通用规则（强约束）

- 积分、库存、次数上限等数值应为非负整数；发放积分与兑换扣减使用正数
- 年次数上限按“自然年”计算（例如 2026 年），校验维度为：代理人 + 积分事项 + 年份
- 并发一致性：年次数上限/库存/兑换次数上限/积分余额扣减等校验需要在同一事务中完成，避免并发绕过
- 发布后的商品不可修改关键信息（标题、说明、兑换积分、兑换次数上限、有效期等）；仅允许下架
- 管理员所有写操作必须记录操作日志（新增/修改/删除/发布/下架/发放/取消等）

## 管理员用户故事

### 1) 录入积分事项

管理员可以录入积分事项，用于决定什么事项可以变成积分、变成多少积分，以及附加规则。

字段：

- 事项名称
- 类别：业绩、招募、晋升、培训等（可扩展）
- 默认积分金额：可不填
- 每年次数上限：可不填（或 0 表示不限，具体以实现约定为准）
- 标准：JSON 字段，可为 null

验收要点：

- 可创建积分事项并在列表中查到
- 默认积分金额为空时，发放积分必须手动填写积分值

### 2) 新增代理人积分

管理员可以给一个代理人新增积分。添加积分记录时需要选择一个积分事项。

规则：

- 提交时校验该积分事项在本自然年的次数上限
- 可添加备注
- 若积分事项未配置默认积分金额，则必须在本次发放时填写积分值；否则使用默认积分金额（是否允许覆盖由产品策略决定）

验收要点：

- 发放成功后生成积分记录
- 发放成功后代理人的当前积分余额正确增加
- 达到上限后继续发放会被拒绝并提示原因
- 写操作落操作日志

### 3) 管理兑换商品

管理员可以新增兑换商品，用来让代理人用积分兑换。字段：

- 兑换类别
- 兑换标题
- 兑换说明
- 兑换须知
- 商品状态：草稿、发布、下架
- 商品图片
- 库存
- 兑换积分
- 可兑换次数：一个代理人最大可兑换多少次
- 有效期至

生命周期规则：

- 草稿：可修改、可删除
- 发布：不可修改关键信息；可下架
- 下架：代理人不可再兑换

验收要点：

- 草稿商品可删除
- 商品一经发布不可修改（除状态流转），且写操作落操作日志


## 代理人用户故事

### 1) 查看兑换商品列表

代理人可以查看兑换商品列表。

验收要点：

- 默认只展示“已发布”的商品
- 商品过期/库存不足时有清晰提示（或按产品策略隐藏）

### 2) 兑换商品

代理人可以兑换商品。

提交时必须校验：

- 商品为已发布且未过期
- 库存充足（扣减库存为原子操作）
- 代理人积分余额足够（扣减积分为原子操作）
- 代理人对该商品的兑换次数未超过上限

验收要点：

- 兑换成功后生成兑换记录
- 兑换成功后库存减少、积分余额减少
- 兑换失败时不产生部分扣减（库存/积分不应出现“只扣其一”）

### 3) 查看我的积分明细

代理人可以查看我的积分明细。

验收要点：

- 能看到当前积分余额
- 能查看积分记录明细（积分事项、积分值、备注、时间等）
-（可选）明细中可合并展示兑换扣减记录，形成统一的积分流水

## 查询能力（补充）

- 管理员：积分事项列表/详情、积分记录查询、兑换商品列表/详情、兑换记录查询、操作日志查询
- 代理人：可兑换商品列表、我的积分余额/明细、我的兑换记录
